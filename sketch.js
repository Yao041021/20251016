// =================================================================
// æ­¥é©Ÿä¸€ï¼šæ¨¡æ“¬æˆç¸¾æ•¸æ“šæ¥æ”¶
// -----------------------------------------------------------------

// ç¢ºä¿é€™æ˜¯å…¨åŸŸè®Šæ•¸
let finalScore = 0; 
let maxScore = 0;
let scoreText = ""; // ç”¨æ–¼ p5.js ç¹ªåœ–çš„æ–‡å­—

// ã€æ–°å¢ã€‘ç”¨æ–¼å„²å­˜æ‰€æœ‰çš„ğŸ‘ç²’å­
let thumbUpParticles = []; 

window.addEventListener('message', function (event) {
    // åŸ·è¡Œä¾†æºé©—è­‰...
    // ...
    const data = event.data;
    
    if (data && data.type === 'H5P_SCORE_RESULT') {
        
        // !!! é—œéµæ­¥é©Ÿï¼šæ›´æ–°å…¨åŸŸè®Šæ•¸ !!!
        finalScore = data.score; // æ›´æ–°å…¨åŸŸè®Šæ•¸
        maxScore = data.maxScore;
        scoreText = `æœ€çµ‚æˆç¸¾åˆ†æ•¸: ${finalScore}/${maxScore}`;
        
        console.log("æ–°çš„åˆ†æ•¸å·²æ¥æ”¶:", scoreText); 
        
        // ----------------------------------------
        // é—œéµæ­¥é©Ÿ 2: å‘¼å«é‡æ–°ç¹ªè£½ (è¦‹æ–¹æ¡ˆäºŒ)
        // ----------------------------------------
        if (typeof redraw === 'function') {
            redraw(); 
        }
    }
}, false);


// =================================================================
// ã€æ–°å¢ã€‘æ­¥é©Ÿä¸‰ï¼šå»ºç«‹ ğŸ‘ ç²’å­çš„é¡åˆ¥ (Class)
// -----------------------------------------------------------------

class ThumbUpParticle {
    constructor(x, y) {
        this.pos = createVector(x, y);
        // è¨­å®šä¸€å€‹å‘ä¸‹çš„éš¨æ©Ÿé€Ÿåº¦
        this.vel = createVector(random(-1, 1), random(2, 5)); 
        this.lifespan = 255; // ç²’å­çš„ç”Ÿå‘½é€±æœŸï¼Œç”¨æ–¼æ·¡å‡ºæ•ˆæœ
        this.size = random(30, 50); // éš¨æ©Ÿå°ºå¯¸
    }

    // æ›´æ–°ç²’å­çš„ä½ç½®
    update() {
        this.pos.add(this.vel);
        // é™ä½ç”Ÿå‘½é€±æœŸï¼Œè®“ç²’å­é€æ¼¸æ¶ˆå¤±
        this.lifespan -= 4; 
    }

    // ç¹ªè£½ç²’å­
    display() {
        // è¨­å®šç¹ªè£½æ–‡å­—çš„é¡è‰²ï¼Œalpha (é€æ˜åº¦) ä½¿ç”¨ lifespan
        fill(0, 0, 0, this.lifespan); 
        textSize(this.size);
        textAlign(CENTER, CENTER);
        // ä½¿ç”¨ p5.js çš„ text() å‡½æ•¸ç¹ªè£½ Emoji
        text("ğŸ‘", this.pos.x, this.pos.y);
    }

    // æª¢æŸ¥ç²’å­æ˜¯å¦ã€Œæ­»äº¡ã€ï¼ˆç”Ÿå‘½é€±æœŸçµæŸï¼‰
    isDead() {
        return this.lifespan < 0;
    }
}


// =================================================================
// æ­¥é©ŸäºŒï¼šä½¿ç”¨ p5.js ç¹ªè£½åˆ†æ•¸ (åœ¨ç¶²é  Canvas ä¸Šé¡¯ç¤º)
// -----------------------------------------------------------------

function setup() { 
    createCanvas(windowWidth / 2, windowHeight / 2); 
    background(255); 
    // å¿…é ˆç§»é™¤ noLoop()ï¼Œç²’å­éœ€è¦æŒçºŒæ›´æ–°ä½ç½® (å‘¼å« draw())
    // è¨»è§£æ‰ noLoop(); è®“ draw å‡½å¼æŒçºŒåŸ·è¡Œ
    // noLoop(); 
} 

// score_display.js ä¸­çš„ draw() å‡½æ•¸ç‰‡æ®µ

function draw() { 
    background(255); // æ¸…é™¤èƒŒæ™¯

    // è¨ˆç®—ç™¾åˆ†æ¯”
    let percentage = (finalScore / maxScore) * 100;

    textSize(80); 
    textAlign(CENTER);
    
    // -----------------------------------------------------------------
    // A. æ ¹æ“šåˆ†æ•¸å€é–“æ”¹è®Šæ–‡æœ¬é¡è‰²å’Œå…§å®¹ (ç•«é¢åæ˜ ä¸€)
    // -----------------------------------------------------------------
    if (percentage >= 90) {
        // æ»¿åˆ†æˆ–é«˜åˆ†ï¼šé¡¯ç¤ºé¼“å‹µæ–‡æœ¬ï¼Œä½¿ç”¨é®®è±”é¡è‰²
        fill(0, 200, 50); // ç¶ è‰² 
        text("æ­å–œï¼å„ªç•°æˆç¸¾ï¼", width / 2, height / 2 - 50);
        
        // ã€æ–°å¢ã€‘ç•¶åˆ†æ•¸é«˜æ–¼ 90% æ™‚ï¼Œä¸æ–·ç”¢ç”Ÿ ğŸ‘ ç²’å­
        if (frameCount % 10 === 0) { // æ¯éš” 10 å¹€ç”¢ç”Ÿä¸€å€‹
            // å¾ç•«é¢ä¸Šæ–¹éš¨æ©Ÿä½ç½®ç”¢ç”Ÿç²’å­
            let startX = random(width); 
            thumbUpParticles.push(new ThumbUpParticle(startX, 0));
        }
        
    } else if (percentage >= 60) {
        // ä¸­ç­‰åˆ†æ•¸ï¼šé¡¯ç¤ºä¸€èˆ¬æ–‡æœ¬ï¼Œä½¿ç”¨é»ƒè‰² 
        fill(255, 181, 35); 
        text("æˆç¸¾è‰¯å¥½ï¼Œè«‹å†æ¥å†å²ã€‚", width / 2, height / 2 - 50);
        
    } else if (percentage > 0) {
        // ä½åˆ†ï¼šé¡¯ç¤ºè­¦ç¤ºæ–‡æœ¬ï¼Œä½¿ç”¨ç´…è‰² 
        fill(200, 0, 0); 
        text("éœ€è¦åŠ å¼·åŠªåŠ›ï¼", width / 2, height / 2 - 50);
        
    } else {
        // å°šæœªæ”¶åˆ°åˆ†æ•¸æˆ–åˆ†æ•¸ç‚º 0
        fill(150);
        text(scoreText, width / 2, height / 2);
    }

    // é¡¯ç¤ºå…·é«”åˆ†æ•¸
    textSize(50);
    fill(50);
    text(`å¾—åˆ†: ${finalScore}/${maxScore}`, width / 2, height / 2 + 50);
    
    
    // -----------------------------------------------------------------
    // B. æ ¹æ“šåˆ†æ•¸è§¸ç™¼ä¸åŒçš„å¹¾ä½•åœ–å½¢åæ˜  (ç•«é¢åæ˜ äºŒ)
    // -----------------------------------------------------------------
    
    if (percentage >= 90) {
        // ç•«ä¸€å€‹å¤§åœ“åœˆä»£è¡¨å®Œç¾ 
        fill(0, 200, 50, 150); // å¸¶é€æ˜åº¦
        noStroke();
        circle(width / 2, height / 2 + 150, 150);
        
    } else if (percentage >= 60) {
        // ç•«ä¸€å€‹æ–¹å½¢ 
        fill(255, 181, 35, 150);
        rectMode(CENTER);
        rect(width / 2, height / 2 + 150, 150, 150);
    }
    
    // -----------------------------------------------------------------
    // ã€æ–°å¢ã€‘C. è™•ç† ğŸ‘ ç²’å­ç³»çµ±
    // -----------------------------------------------------------------
    // å¾é™£åˆ—çš„**å°¾ç«¯**å‘å‰è¿­ä»£ï¼Œä»¥ä¾¿å®‰å…¨åœ°ç§»é™¤å…ƒç´ 
    for (let i = thumbUpParticles.length - 1; i >= 0; i--) {
        let p = thumbUpParticles[i];
        p.update();
        p.display();

        // æª¢æŸ¥ç²’å­æ˜¯å¦æ­»äº¡ï¼Œå¦‚æœæ˜¯ï¼Œå‰‡å¾é™£åˆ—ä¸­ç§»é™¤
        if (p.isDead()) {
            thumbUpParticles.splice(i, 1);
        }
    }
}
